---
output: html_document
author: AEN and MCF
title: Negpad felicity
---

Prelims and libraries.

```{r}
rm(list=ls())
#Load libraries
library(reshape2)
library(dplyr)
library(ggplot2)
library(bootstrap)
library(lme4)
```

We're going to use Stan. Set some settings:

```{r}
library(rstan)
library(rstanmulticore)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

Functions and add some style elements for ggplot2

```{r}
## number of unique subs
n.unique <- function (x) {
  length(unique(x))
}

## for bootstrapping 95% confidence intervals
theta <- function(x,xdata) {mean(xdata[x])}
ci.low <- function(x) {
  quantile(bootstrap(1:length(x),1000,theta,x)$thetastar,.025)}
ci.high <- function(x) {
  quantile(bootstrap(1:length(x),1000,theta,x)$thetastar,.975)}

plot.style <- theme_bw() + 
  theme(panel.grid.minor=element_blank(), 
        panel.grid.major=element_blank(), 
        legend.position="right", 
        axis.line = element_line(colour="black",size=.5), 
        axis.ticks = element_line(size=.5), 
        axis.title.x = element_text(vjust=-.5), 
        axis.title.y = element_text(angle=90,vjust=0.25))
```

Load in data.

```{r}
all.data <- read.csv("negpad_long_data.csv")
```

Condense scale (1=bad, 2=neutral, 3=good)

```{r}
all.data$resp2 <- 2
all.data[all.data$resp > 3,]$resp2 <- 3
all.data[all.data$resp < 3,]$resp2 <- 1
all.data$resp2 <- factor(all.data$resp2)
```

### Participant exclusions

Reject subjects who don't understand scale (based on positive sentences):

```{r}
reject <- all.data %>%
  filter(sent.type=="positive") %>% #Only look at positive sentences
  group_by(subid) %>%
  mutate(total = n()) %>% #get total # of positive sentences child saw
  group_by(subid, condition, truth, total, resp2) %>%
  filter((truth=="True" & resp2==3) | (truth=="False" & resp2==1)) %>% #Get # "good" for true pos and "bad" for false pos
  summarize(counts = n()) %>% 
  group_by(subid, condition, total) %>%
  summarize(counts = sum(counts)) %>% #total # "correct" responses
  mutate(prop = counts/total) %>% #proportion correct
  filter(prop < .6) #reject kids who got < .6 "correct" (this allows for 2/6 "mistakes")

for (i in reject$subid) {
  all.data <- filter(all.data, subid !=i)
}
```

Make sure there aren't any kids who just used one side of scale. Reject kids who only chose a single data point

```{r}
scaleUse <- aggregate(resp2 ~ subid, all.data, n.unique)
table(scaleUse$resp2) #Are any resp2=1
```

### Categorize kids based on response type

```{r}
tn_responses <- all.data %>%
  filter(sent.type=="negative" & truth=="True") %>%
  group_by(subid) %>%
  mutate(total = n()) %>%
  group_by(subid, condition, total, resp2) %>%
  summarize(counts = n()) %>%
  mutate(prop = counts/total)

category <- dcast(tn_responses, subid + condition ~ resp2)
names(category) <- c("subid","condition","bad","neutral","good")
category[is.na(category)] <- 0

category$type <- "other"
#category[category$neutral > .6,]$type <- "tn_neutral"
category[category$bad > .6,]$type <- "tn_bad"
category[category$good > .6,]$type <- "tn_good"

cat_counts <- category %>%
  group_by(condition, type) %>%
  summarise(counts = n())
cat_counts$condition <- factor(cat_counts$condition, levels=c("none","target"), labels=c("None","Target"))
cat_counts$type <- factor(cat_counts$type, levels=c("tn_bad","tn_good","other"), labels=c("True Negatives = Bad", "True Negatives = Good", "Inconsistent/Other"))

qplot(data=cat_counts, x=condition, y=counts, fill=type, 
      stat="identity", position="dodge", geom="bar") + 
  scale_fill_hue("Response Type") +
  ylab("Count") + xlab("Context Condition") +
  plot.style
```

Main Analysis
-------------

### First aross ages

```{r}
ms <- all.data %>%
  group_by(subid, condition, sent.type, truth) %>%
  summarise(subm = mean(resp)) %>%
  group_by(condition, sent.type, truth) %>%
  summarise(m = mean(subm),
            cih = ci.high(subm),
            cil = ci.low(subm))
ms$condition <- factor(ms$condition, labels=c("None","Target"))
ms$truth <- factor(ms$truth, levels=c("True","False"))

qplot(data=subset(ms, sent.type=="negative"), 
      x=condition, y=m, facets=~truth,
      stat="identity", position="dodge", geom="bar") +
  geom_errorbar(aes(ymin=cil, ymax=cih), 
                position=position_dodge(.9), width=0) + 
  scale_fill_grey("") +
  xlab("Context") + ylab("Response") +
  scale_y_continuous(limits=c(0, 5), breaks=seq(1,5,1)) +
  #coord_equal(1/1.5) +
  plot.style
```

Histogram of responses

```{r}
truenegs <- filter(ms, truth=="True" & sent.type == "negative")

#make df for histogram (for formatting reasons)
hist_data <- all.data %>%
  filter(truth=="True" & sent.type=="negative") %>%
  group_by(condition, resp) %>%
  summarise(count = n())
hist_data$condition <- factor(hist_data$condition, labels=c("None","Target"))


qplot(data=hist_data, y=count, x=resp, 
      fill = condition, width=.5, 
      geom="bar", position = position_dodge(.6), stat="identity") +
  geom_point(data=truenegs, aes(x=m, y=c(41, 42), color=condition)) +
  geom_segment(data=truenegs, aes(x=cil, xend=cih, y=c(41, 42), yend=c(41, 42), color=condition)) + 
  scale_fill_grey("Condition") + scale_color_grey("Condition") +
  xlab("Response") + ylab("Count") +
  #ggtitle("True Negatives, 3-5-year-olds (N=43)") +
  plot.style
```

### Break down by age.

```{r}
ms <- all.data %>%
  group_by(subid, agegroup, condition, sent.type, truth) %>%
  summarise(subm = mean(resp)) %>%
  group_by(condition, agegroup, sent.type, truth) %>%
  summarise(m = mean(subm),
            cih = ci.high(subm),
            cil = ci.low(subm))
ms$condition <- factor(ms$condition, labels=c("None","Target"))
ms$truth <- factor(ms$truth, levels=c("True","False"))

qplot(data=subset(ms, sent.type=="negative"), 
      x=condition, y=m, facets=agegroup~truth,
      stat="identity", position="dodge", geom="bar") +
  geom_errorbar(aes(ymin=cil, ymax=cih), 
                position=position_dodge(.9), width=0) + 
  scale_fill_grey("") +
  xlab("Context") + ylab("Response") +
  scale_y_continuous(limits=c(0, 5), breaks=seq(1,5,1)) +
  #coord_equal(1/1.5) +
  plot.style
```

Histogram of responses

```{r}
trueneg_3s <- filter(ms, truth=="True" & sent.type == "negative" & agegroup == "3")
trueneg_4s <- filter(ms, truth=="True" & sent.type == "negative" & agegroup == "4")

hist_data_3s <- all.data %>%
  filter(truth=="True" & sent.type=="negative" & agegroup=="3") %>%
  group_by(condition, resp) %>%
  summarise(count = n())
hist_data_3s$condition <- factor(hist_data_3s$condition, labels=c("None","Target"))

#quartz()
qplot(data=hist_data_3s, y=count, x=resp, 
      fill = condition, width=.5, 
      geom="bar", position = position_dodge(.6), stat="identity") +
  geom_point(data=trueneg_3s, aes(x=m, y=c(40, 41), color=condition)) +
  geom_segment(data=trueneg_3s, aes(x=cil, xend=cih, y=c(40, 41), yend=c(40, 41), color=condition)) + 
  scale_fill_grey("Condition") + scale_color_grey("Condition") +
  xlab("Response") + ylab("Count") +
  ylim(c(0, 80)) + 
  #ggtitle("True Negatives, 3-year-olds (N=35)") +
  plot.style

hist_data_4s <- all.data %>%
  filter(truth=="True" & sent.type=="negative" & agegroup=="4") %>%
  group_by(condition, resp) %>%
  summarise(count = n())
hist_data_4s$condition <- factor(hist_data_4s$condition, labels=c("None","Target"))

#quartz()
qplot(data=hist_data_4s, y=count, x=resp, 
      fill = condition, width=.5, 
      geom="bar", position = position_dodge(.6), stat="identity") +
  geom_point(data=trueneg_4s, aes(x=m, y=c(40, 41), color=condition)) +
  geom_segment(data=trueneg_4s, aes(x=cil, xend=cih, y=c(40, 41), yend=c(40, 41), color=condition)) + 
  scale_fill_grey("Condition") + scale_color_grey("Condition") +
  xlab("Response") + ylab("Count") +
  ylim(c(0, 80)) + 
  #ggtitle("True Negatives, 4-year-olds (N=34)") +
  plot.style
```

### Playing around

```{r}
ms <- all.data %>%
  group_by(sent.type, truth, condition, subid) %>%
  summarise(resp = mean(resp)) %>%
  group_by(sent.type, truth, condition) %>%
  summarise(cih = ci.high(resp),
            cil = ci.low(resp),
            m = mean(resp)) 

ggplot(ms, aes(x = sent.type, y = m, fill = condition)) + 
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = cil, ymax = cih), 
                 position = position_dodge(width = .9)) +
  facet_grid(.~truth)
```

Statistics
----------

### Basic continuous models.

```{r}
summary(lmer(resp ~ condition * agegroup * truth  + (1|subid) 
     + (1|item), 
     data = filter(all.data, sent.type == "negative")))

summary(lmer(resp ~ condition * agegroup + 
               (1|subid) + (1|item), 
             data = filter(all.data, sent.type == "negative" & truth == "True")))
```

Some simpler models, including within-agegroup.

```{r}
model <- lmer(resp ~ condition*agegroup +
                (1 | subid) + 
                (1 | item), 
              data=subset(all.data, sent.type == "negative" & truth == "True"))
summary(model)

threes <- filter(all.data, agegroup == "3")
threes_subs <- aggregate(resp ~ subid + condition, threes, mean)
t.test(resp ~ condition, threes_subs)

fours <- filter(all.data, agegroup == "4")
fours_subs <- aggregate(resp ~ subid + condition, fours, mean)
t.test(resp ~ condition, fours_subs)

subs <- aggregate(resp ~ subid + condition, all.data, mean)
t.test(resp ~ condition, subs)
```

### Discrete models

```{r}
all.data$bin.resp <- all.data$resp > 3

ms <- all.data %>%
  group_by(sent.type, truth, condition, agegroup, subid) %>%
  summarise(resp = mean(bin.resp)) %>%
  group_by(sent.type, truth, condition, agegroup) %>%
  summarise(cih = ci.high(resp),
            cil = ci.low(resp),
            m = mean(resp)) 

ggplot(ms, aes(x = sent.type:truth, y = m, fill = condition)) + 
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = cil, ymax = cih), 
                 position = position_dodge(width = .9)) +
  facet_grid(.~agegroup)

summary(glmer(bin.resp ~ (condition + agegroup + truth)^3  + (1|subid) 
             + (1|item), family = "binomial",
             data = filter(all.data, sent.type == "negative")))

summary(glmer(bin.resp ~ (condition + agegroup + truth)^2  + (1|subid) 
             + (1|item), family = "binomial",
             data = filter(all.data, sent.type == "negative")))

summary(glmer(bin.resp ~ condition + agegroup + (1|subid), 
              family = "binomial",
              data = filter(all.data, 
                            truth == "True",
                            sent.type == "negative")))

## yields an interaction - doesn't converge with sent.type in ranef
summary(glmer(bin.resp ~ condition * sent.type + agegroup + (1|subid),
              family = "binomial",
              data = filter(all.data, 
                            truth == "True")))

## yields an interaction 
summary(glmer(bin.resp ~ condition * truth + (1|subid), 
              family = "binomial",
              data = filter(all.data, 
                            sent.type == "negative")))

## doesn't converge
summary(glmer(bin.resp ~ condition * sent.type * truth + (1|subid), 
              family = "binomial",
              data = filter(all.data)))

```


Try creating a "correct" variable.

```{r}
all.data <- all.data %>%
  mutate(correct = ifelse(truth == "True", resp > 3, resp <= 3))

ms <- all.data %>%
  group_by(sent.type, truth, condition, agegroup, subid) %>%
  summarise(correct = mean(correct)) %>%
  group_by(sent.type, truth, agegroup, condition) %>%
  summarise(cih = ci.high(correct),
            cil = ci.low(correct),
            m = mean(correct)) 

ggplot(ms, aes(x = sent.type, y = m, fill = condition)) + 
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = cil, ymax = cih), 
                 position = position_dodge(width = .9)) +
  facet_grid(agegroup ~ truth)


## doesn't converge
summary(glmer(correct ~ condition * sent.type * truth + agegroup + 
                (1|subid), 
              family = "binomial",
              data = all.data))

## yields an interaction - doesn't converge with sent.type in ranef
summary(glmer(bin.resp ~ condition * sent.type + agegroup + (1|subid),
              family = "binomial",
              data = filter(all.data, 
                            truth == "True")))


## yields no interaction 
summary(glmer(bin.resp ~ condition * truth + agegroup + (1|subid), 
              family = "binomial",
              data = filter(all.data, 
                            sent.type == "negative")))
```


### Subjectwise mean distribution

```{r}
ms <- all.data %>%
  group_by(sent.type, truth, condition, agegroup, subid) %>%
  summarise(m = mean(resp))
  
qplot(round(m),
      fill = condition, 
      facets = ~ agegroup,
      position = "dodge", 
      binwidth = .5,
      data = filter(ms, truth == "True" & 
                    sent.type == "negative"))
```

### Ad-hoc stats

First - this measure is definitely bimodal.

```{r}
library(diptest)
dip.test(all.data$resp)
dip.test(all.data$resp[all.data$condition == "none"])
dip.test(all.data$resp[all.data$condition == "target"])
```

Second, we can reject the null of no condition difference if we treat trials independently with $\chi^2$.

```{r}
ms <- all.data %>%
  filter(truth == "True", sent.type == "negative")

qplot(resp, fill = condition, position = "dodge",  data=ms) 

xtab <- xtabs(~ factor(resp) +  condition, data= ms)
chisq.test(xtab)
```

Can we do subject averages?

```{r}
ms <- all.data %>%
  filter(truth == "True", sent.type == "negative") %>%
  group_by(subid, condition) %>%
  summarise(resp = mean(resp))

qplot(resp, fill = condition, position = "dodge",  binwidth = 1, data=ms) 

xtab <- xtabs(~ factor(floor(resp)) +  condition, data= ms)
chisq.test(xtab)
```

Ok, so this average actually destroys some structure in the data, because participants are actually idiosyncratic in their answers.

Some pairwise analysis. 

```{r}
ms <- all.data %>%
  filter(truth == "True", sent.type == "negative") %>%
  group_by(subid, condition) %>%
  summarise(resp = mean(resp), 
            correct = mean(correct))

with(ms, t.test(resp[condition == "none"], resp[condition == "target"]))
with(ms, t.test(correct[condition == "none"], correct[condition == "target"]))
```

and within age groups.

```{r}
ms <- all.data %>%
  filter(truth == "True", sent.type == "negative") %>%
  group_by(subid, condition, agegroup) %>%
  summarise(resp = mean(resp), 
            correct = mean(correct))

with(ms, t.test(resp[condition == "none" & agegroup == 3], 
                resp[condition == "target" & agegroup == 3]))
with(ms, t.test(correct[condition == "none" & agegroup == 3], 
                correct[condition == "target" & agegroup == 3]))

with(ms, t.test(resp[condition == "none" & agegroup == 4], 
                resp[condition == "target" & agegroup == 4]))
with(ms, t.test(correct[condition == "none" & agegroup == 4], 
                correct[condition == "target" & agegroup == 4]))
```

